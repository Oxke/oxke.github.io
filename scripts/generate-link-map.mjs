import { promises as fs } from "node:fs";
import path from "node:path";

const projectRoot = process.cwd();
const contentsDir = path.join(projectRoot, "src", "contents");
const outputFile = path.join(projectRoot, "src", "linkMap.generated.ts");

const normalizeTopic = (value) => {
  const topic = value.trim().toLowerCase();
  return topic.startsWith("\\") ? topic : `\\${topic}`;
};

const readContentFiles = async () => {
  const entries = await fs.readdir(contentsDir, { withFileTypes: true });
  return entries
    .filter((entry) => entry.isFile() && entry.name.endsWith(".tsx"))
    .map((entry) => entry.name)
    .sort((a, b) => a.localeCompare(b));
};

const extractTopicLinks = (source, fileContent, validTopics) => {
  const links = new Set();
  const topicButtonRegex = /<TopicButton\b[\s\S]*?(?:\/\>|>[\s\S]*?<\/TopicButton>)/g;

  for (const match of fileContent.matchAll(topicButtonRegex)) {
    const snippet = match[0];
    if (!/\bonClick\s*=/.test(snippet)) continue;

    const textMatch = snippet.match(/\btext\s*=\s*"([^"]+)"/);
    if (!textMatch) continue;

    const target = normalizeTopic(textMatch[1]);
    if (target !== source && validTopics.has(target)) {
      links.add(target);
    }
  }

  return [...links].sort((a, b) => a.localeCompare(b));
};

const renderOutput = (map) => {
  const escapeForTsString = (value) =>
    value.replace(/\\/g, "\\\\").replace(/"/g, '\\"');

  const entries = Object.entries(map)
    .map(([key, values]) => {
      const renderedKey = escapeForTsString(key);
      const renderedValues = values
        .map((value) => `"${escapeForTsString(value)}"`)
        .join(", ");
      return `  "${renderedKey}": [${renderedValues}],`;
    })
    .join("\n");

  return `// This file is auto-generated by scripts/generate-link-map.mjs\n// Do not edit manually.\n\nexport const generatedLinkMap: Record<string, string[]> = {\n${entries}\n};\n`;
};

const generate = async () => {
  const files = await readContentFiles();
  const topics = files.map((fileName) => normalizeTopic(path.basename(fileName, ".tsx")));
  const validTopics = new Set(topics);

  const map = {};

  for (const fileName of files) {
    const source = normalizeTopic(path.basename(fileName, ".tsx"));
    const filePath = path.join(contentsDir, fileName);
    const content = await fs.readFile(filePath, "utf8");
    map[source] = extractTopicLinks(source, content, validTopics);
  }

  const output = renderOutput(map);
  await fs.writeFile(outputFile, output, "utf8");
  console.log(`Generated link map for ${files.length} content files.`);
};

generate().catch((error) => {
  console.error("Failed to generate link map:", error);
  process.exit(1);
});
